{% extends 'main.html.twig' %}

{% block body %}
<section class="ajouter_au_panier mt-5">
  <div class="container">
    <h2 class="text-center mb-4">Votre Panier</h2>

    {# Flash messages #}
    {% for message in app.flashes('success') %}
      <div class="alert alert-success">{{ message }}</div>
    {% endfor %}

    <div class="row panier_card">

      {# Form Section: Only show if panier is not empty and form exists #}
      {% if panier is not empty and form is defined and form is not null %}
        <div class="{% if panier|length > 4 %}col-md-12{% else %}col-md-6{% endif %}">
          {{ form_start(form, {'attr': {'class': 'form-section', 'id': 'checkoutForm'}}) }}

          <h5 class="mb-3">Informations de livraison</h5>

          {# Email #}
          <div class="mb-3">
            {% if client.clientEmail %}
              <label>Utiliser email existant ?</label><br>
              <input type="radio" name="use_existing_email" value="yes" checked> Oui ({{ client.clientEmail }})<br>
              <input type="radio" name="use_existing_email" value="no"> Non, nouveau email
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.client_email, {
                'attr': {'class': 'form-control', 'id': 'floatingEmail', 'placeholder': 'Email'}
              }) }}
              <label for="floatingEmail">Email</label>
            </div>
          </div>

          {# Phone #}
          <div class="mb-3">
            {% if client.clientPhone %}
              <label>Utiliser téléphone existant ?</label><br>
              <input type="radio" name="use_existing_phone" value="yes" checked> Oui ({{ client.clientPhone }})<br>
              <input type="radio" name="use_existing_phone" value="no"> Non, nouveau téléphone
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.client_phone, {
                'attr': {'class': 'form-control', 'id': 'floatingPhone', 'placeholder': 'Phone'}
              }) }}
              <label for="floatingPhone">Téléphone</label>
            </div>
          </div>

          {# Adresse Livraison #}
          <div class="mb-3">
            {% if client.adresseLivraison %}
              <label>Utiliser adresse existante ?</label><br>
              <input type="radio" name="use_existing_address" value="yes" checked> Oui ({{ client.adresseLivraison }})<br>
              <input type="radio" name="use_existing_address" value="no"> Non, nouvelle adresse
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.adresseLivraison, {
                'attr': {'class': 'form-control', 'id': 'floatingAddress', 'placeholder': 'Adresse'}
              }) }}
              <label for="floatingAddress">Adresse de Livraison</label>
            </div>
          </div>

          {# Code Postal Livraison #}
          <div class="mb-3">
            {% if client.codePostalLivraison %}
              <label>Utiliser code postal existant ?</label><br>
              <input type="radio" name="use_existing_postal" value="yes" checked> Oui ({{ client.codePostalLivraison }})<br>
              <input type="radio" name="use_existing_postal" value="no"> Non, nouveau code postal
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.codePostalLivraison, {
                'attr': {'class': 'form-control', 'id': 'floatingPostal', 'placeholder': 'Code Postal'}
              }) }}
              <label for="floatingPostal">Code Postal</label>
            </div>
          </div>

          {# Button triggers modal instead of submitting directly #}
          <button type="button" id="checkoutBtn" class="btn confirm-btn w-100 mt-3 btn-primary">
            Confirmer
          </button>

          {{ form_end(form) }}
        </div>
      {% endif %}

      {# Panier Items Section or Empty Message #}
      <div class="{% if panier|length > 4 %}col-md-12 mt-4{% else %}col-md-6{% endif %}">
        {% if panier is empty %}
          <div class="alert alert-warning text-center" role="alert" style="border-radius: 12px; font-size: 1.2rem;">
            <br>
            Votre panier est actuellement vide !<br>
            Commencez à ajouter des produits pour passer votre commande.
            <br><br>
            <a href="{{ path('main_produit') }}" class="btn btn-primary mt-2">Commencer vos achats</a>
          </div>
        {% else %}
          {% for item in panier %}
            <div class="panier-item d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center">
                <img src="{{ item.produit.photo }}" alt="{{ item.produit.nomProduit }}" height="100px" width="100px" />
                <div class="ms-3">
                  <p class="mb-1 fw-bold">{{ item.produit.nomProduit }}</p>
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <a href="/panier/del/{{ item.produit.id }}" class="btn btn-sm btn-secondary fw-bold">-</a>
                    <span>{{ item.quantite }}</span>
                    <a href="/panier/add/{{ item.produit.id }}" class="btn btn-sm btn-secondary fw-bold">+</a>
                  </div>
                  <p class="mb-0 fw-bold">{{ item.produit.ventPrix|number_format(2, '.', ',') }} €</p>
                </div>
              </div>
              <form method="post" action="{{ path('main_del_panier', {'id': item.produit.id}) }}">
                <button type="submit" class="btn btn-sm btn-danger ms-3">Supprimer</button>
              </form>
            </div>
          {% endfor %}
          <div class="total-section text-end mt-4">
            <h5 class="fw-bold">Total: {{ totalPrice|number_format(2, '.', ',') }} €</h5>
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  {# Payment Modal #}
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Choisissez un mode de paiement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="paymentMethod" class="form-label">Méthode de paiement :</label>
            <select id="paymentMethod" name="payment_method" class="form-select" required>
              <option value="credit_card">Carte de Crédit</option>
              <option value="paypal">PayPal</option>
              <option value="bank_transfer">Virement Bancaire</option>
              <option value="cash">Espèces</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning w-100" id="confirmPaymentBtn">Valider la commande</button>
        </div>
      </div>
    </div>
  </div>

</section>

{# JS for enabling/disabling and modal #}
<script>
  const radiosMap = {
    'use_existing_email': 'client_email',
    'use_existing_phone': 'client_phone',
    'use_existing_address': 'adresseLivraison',
    'use_existing_postal': 'codePostalLivraison'
  };

  Object.keys(radiosMap).forEach(radioName => {
    document.querySelectorAll('input[name="'+radioName+'"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const input = document.querySelector('#checkoutForm [name="checkout['+radiosMap[radioName]+']"]');
        if (!input) return;
        // disable input if "yes" or if no client data exists
        if (this.value === 'yes') {
          input.disabled = true;
        } else {
          input.disabled = false;
        }
      });
      radio.dispatchEvent(new Event('change'));
    });
  });

  // Checkout modal logic
  document.getElementById('checkoutBtn').addEventListener('click', function() {
    const form = document.getElementById('checkoutForm');
    if (form.checkValidity()) {
      const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
      paymentModal.show();
    } else {
      form.reportValidity();
    }
  });

  document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
    const form = document.getElementById('checkoutForm');
    const paymentMethod = document.getElementById('paymentMethod').value;

    let input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'payment_method';
    input.value = paymentMethod;
    form.appendChild(input);

    form.submit();
  });
</script>

{% endblock %}
