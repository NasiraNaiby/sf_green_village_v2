{% extends 'main.html.twig' %}

{% block body %}
<section class="ajouter_au_panier mt-5">
  <div class="container">
    <h2 class="text-center mb-4">Votre Panier</h2>


{% for message in app.flashes('success') %}
  <div class="alert alert-dismissible fade show d-flex align-items-center justify-content-between" role="alert" 
       style="background-color: #0a5f43; color: #fff; border-radius: 10px; padding: 15px; font-size: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.15);">
    <div>
      <i class="bi bi-check-circle-fill me-2"></i> {{ message }}
    </div>
    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
{% endfor %}



    <div class="row panier_card">

      {# Form Section: Only show if panier is not empty and form exists #}
      {% if panier is not empty and form is defined and form is not null %}
        <div class="{% if panier|length > 4 %}col-md-12{% else %}col-md-6{% endif %}">
          {{ form_start(form, {'attr': {'class': 'form-section', 'id': 'checkoutForm'}}) }}

          <h5 class="mb-3">Informations de livraison</h5>

          {# Email #}
          <div class="mb-3">
            {% set emailDisabled = client.clientEmail is defined and client.clientEmail ? true : false %}
            {% if emailDisabled %}
              <label>Utiliser email existant ?</label><br>
              <input type="radio" name="use_existing_email" value="yes" > Oui ({{ client.clientEmail }})<br>
              <input type="radio" name="use_existing_email" value="no" checked> Non, nouveau email
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.client_email, {
                'attr': {'class': 'form-control', 'id': 'floatingEmail', 'placeholder': 'Email', 'disabled': emailDisabled}
              }) }}
              <label for="floatingEmail">Email</label>
            </div>
          </div>

          {# Phone #}
          <div class="mb-3">
            {% set phoneDisabled = client.clientPhone is defined and client.clientPhone ? true : false %}
            {% if phoneDisabled %}
              <label>Utiliser téléphone existant ?</label><br>
              <input type="radio" name="use_existing_phone" value="yes" > Oui ({{ client.clientPhone }})<br>
              <input type="radio" name="use_existing_phone" value="no" checked> Non, nouveau téléphone
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.client_phone, {
                'attr': {'class': 'form-control', 'id': 'floatingPhone', 'placeholder': 'Phone', 'disabled': phoneDisabled}
              }) }}
              <label for="floatingPhone">Téléphone</label>
            </div>
          </div>

          {# Address #}
          <div class="mb-3">
            {% set addressDisabled = client.adresseLivraison is defined and client.adresseLivraison ? true : false %}
            {% if addressDisabled %}
              <label>Utiliser adresse existante ?</label><br>
              <input type="radio" name="use_existing_address" value="yes" > Oui ({{ client.adresseLivraison }})<br>
              <input type="radio" name="use_existing_address" value="no" checked> Non, nouvelle adresse
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.adresseLivraison, {
                'attr': {'class': 'form-control', 'id': 'floatingAddress', 'placeholder': 'Adresse', 'disabled': addressDisabled}
              }) }}
              <label for="floatingAddress">Adresse de Livraison</label>
            </div>
          </div>

          {# Postal Code #}
          <div class="mb-3">
            {% set postalDisabled = client.codePostalLivraison is defined and client.codePostalLivraison ? true : false %}
            {% if postalDisabled %}
              <label>Utiliser code postal existant ?</label><br>
              <input type="radio" name="use_existing_postal" value="yes" > Oui ({{ client.codePostalLivraison }})<br>
              <input type="radio" name="use_existing_postal" value="no" checked> Non, nouveau code postal
            {% endif %}
            <div class="form-floating mt-2">
              {{ form_widget(form.codePostalLivraison, {
                'attr': {'class': 'form-control', 'id': 'floatingPostal', 'placeholder': 'Code Postal', 'disabled': postalDisabled}
              }) }}
              <label for="floatingPostal">Code Postal</label>
            </div>
          </div>

          {# Button triggers modal instead of submitting directly #}
          <button type="button" id="checkoutBtn" class="btn confirm-btn w-100 mt-3 btn-primary">
            Confirmer
          </button>

          {{ form_end(form) }}
        </div>
      {% endif %}

      {# Panier Items Section or Empty Message #}
      <div class="{% if panier|length > 4 %}col-md-12 mt-4{% else %}col-md-6{% endif %}">
        {% if panier is empty %}
          <div class="alert alert-warning text-center" role="alert" style="border-radius: 12px; font-size: 1.2rem;">
            <br>
            Votre panier est actuellement vide !<br>
            Commencez à ajouter des produits pour passer votre commande.
            <br><br>
            <a href="{{ path('main_produit') }}" class="btn btn-primary mt-2">Commencer vos achats</a>
          </div>
        {% else %}
          {% for item in panier %}
            <div class="panier-item d-flex align-items-center justify-content-between mb-4">
              <div class="d-flex align-items-center">
                <img src="{{ item.produit.photo }}" alt="{{ item.produit.nomProduit }}" height="100px" width="100px" />
                <div class="ms-3">
                  <p class="mb-1 fw-bold">{{ item.produit.nomProduit }}</p>
                  <div class="d-flex align-items-center gap-2 mb-1">
                    <a href="/panier/del/{{ item.produit.id }}" class="btn btn-sm btn-secondary fw-bold">-</a>
                    <span>{{ item.quantite }}</span>
                    <a href="/panier/add/{{ item.produit.id }}" class="btn btn-sm btn-secondary fw-bold">+</a>
                  </div>
                  <p class="mb-0 fw-bold">{{ item.produit.ventPrix|number_format(2, '.', ',') }} €</p>
                </div>
              </div>
              <form method="post" action="{{ path('main_del_panier', {'id': item.produit.id}) }}">
                <button type="submit" class="btn btn-sm btn-danger ms-3">Supprimer</button>
              </form>
            </div>
          {% endfor %}
          <div class="total-section text-end mt-4">
            <h5 class="fw-bold">Total: {{ totalPrice|number_format(2, '.', ',') }} €</h5>
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  {# Payment Modal #}
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">Choisissez un mode de paiement</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="paymentMethod" class="form-label">Méthode de paiement :</label>
            <select id="paymentMethod" name="payment_method" class="form-select" required>
              <option value="credit_card">Carte de Crédit</option>
              <option value="paypal">PayPal</option>
              <option value="bank_transfer">Virement Bancaire</option>
              <option value="cash">Espèces</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-warning w-100" id="confirmPaymentBtn">Valider la commande</button>
        </div>
      </div>
    </div>
  </div>

</section>

{# JS for enabling/disabling and modal #}
<script>
const radioInputMap = {
    'use_existing_email': 'checkout[client_email]',
    'use_existing_phone': 'checkout[client_phone]',
    'use_existing_address': 'checkout[adresseLivraison]',
    'use_existing_postal': 'checkout[codePostalLivraison]'
};

Object.keys(radioInputMap).forEach(radioName => {
    document.querySelectorAll('input[name="'+radioName+'"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const input = document.querySelector('[name="'+radioInputMap[radioName]+'"]');
            if (!input) return;
            input.disabled = (this.value === 'yes');
        });
        radio.dispatchEvent(new Event('change')); // set initial state
    });
});

// Checkout modal logic
document.getElementById('checkoutBtn').addEventListener('click', function() {
    const form = document.getElementById('checkoutForm');
    if (form.checkValidity()) {
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        paymentModal.show();
    } else {
        form.reportValidity();
    }
});

document.getElementById('confirmPaymentBtn').addEventListener('click', function() {
    const form = document.getElementById('checkoutForm');
    const paymentMethod = document.getElementById('paymentMethod').value;

    let input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'payment_method';
    input.value = paymentMethod;
    form.appendChild(input);

    form.submit();
});
</script>

{% endblock %}
