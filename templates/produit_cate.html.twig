{% extends 'main.html.twig' %}

{% block body %}
<section class="produit_section mt-5">
  <div class="container">
    <h2 class="text-center mb-4">Produits de la catégorie {{ cat.nomCat }}</h2>

    {% set produitsFiltres = produits|filter(p => p.categorie is defined and p.categorie is not null and p.categorie.id == cat.id) %}

    {% if produitsFiltres|length > 0 %}
      <div class="row g-4">
        {% for produit in produitsFiltres %}
          <div class="col-md-3 col-sm-6 d-flex">
            <div class="card shadow-sm w-100 position-relative hover-scale">

              <!-- Product Image with Wishlist Heart -->
              <div class="card-img-container overflow-hidden" style="height:200px;">
                <img src="{{ produit.photo }}" class="card-img-top img-fluid w-100 h-100" alt="{{ produit.nomProduit }}">
                <button class="btn btn-sm btn-light position-absolute top-0 end-0 m-2 heart-btn" data-produit-id="{{ produit.id }}">
                  <i class="bi bi-heart"></i>
                </button>
              </div>

              <div class="card-body d-flex flex-column p-3">
                <h5 class="card-title fw-bold mb-1">{{ produit.nomProduit }}</h5>
                <p class="card-text text-muted small mb-1">{{ produit.descProduit|length > 60 ? produit.descProduit[:60] ~ '...' : produit.descProduit }}</p>
                <p class="card-text fw-bold h6 mb-2">{{ produit.ventPrix }} €</p>
                <a href="/panier/add/{{ produit.id }}" class="btn btn-primary mt-auto btn-sm">Ajouter au panier</a>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-center">Aucun produit trouvé pour cette catégorie.</p>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Heart toggle for wishlist
    document.querySelectorAll('.heart-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const produitId = this.dataset.produitId;
            const icon = this.querySelector('i');

            // Toggle icon
            icon.classList.toggle('bi-heart-fill');
            icon.classList.toggle('bi-heart');

            // Send fetch request to toggle favoris
            fetch(`/wishlist/toggle/${produitId}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(res => res.json())
              .then(data => {
                  // Remove card if removed from wishlist
                  if (data.removed) {
                      this.closest('.col-md-3').remove();
                  }
              });
        });
    });
});
</script>
{% endblock %}
